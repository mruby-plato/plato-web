<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Plato Web Tool</title>
<script type="text/javascript" src="js/bluejelly.js"></script>
<script type="text/javascript" src="js/bj-plato.js"></script>
<script type="text/javascript" src="js/plato-web.js"></script>
<style type="text/css">
td {
  text-align: center;
}
</style>
</head>
<body>
<div>
  Plato devices:
  <table>
    <tr>
      <th>Device name</th>
      <th>ID</th>
      <!-- <th>Address</th> -->
      <th>Status</th>
    </tr>
    <tr id="bt0"></tr>
    <tr id="bt1"></tr>
    <tr id="bt2"></tr>
    <tr id="bt3"></tr>
    <tr id="bt4"></tr>
    <tr id="bt5"></tr>
    <tr id="bt6"></tr>
    <tr id="bt7"></tr>
    <tr id="bt8"></tr>
    <tr id="bt9"></tr>
  </table>
  <div>
    <button id="bt_scan" onclick="scanDevice()">Scan</button>
    <!-- <button onclick="btdevs[0].bt.read('Major')">Major[0]</button> -->
    <!-- <button onclick="btdevs[1].bt.read('Major')">Major[1]</button> -->
  </div>
  <div>
    <input type="file" id="fl_appbin">
    <div id="load_status"></div>
  </div>
  <div>
    <button id="bt_wrtapp" onclick="writeAppl()">Deploy</button>
  </div>
</div>

<div id="text1">Hello, Plato!</div>
<div id="devname">&lt;device&gt;</div>
<div>
  iBeacon Service
  <button id="bt_proximity">Proximity UUID</button>
  <button id="bt_major">Major</button>
  <button id="bt_minor">Minor</button>
  <button id="bt_txpwr">TX Power</button>
  <button id="bt_advint">Adv. Interval</button>
  <button id="bt_mespwr">Measure Power</button>
  <button id="bt_regi">Register</button>
</div>
<div>
  Data Service
  <button id="button1">Start read</button>
  <button id="button2">Stop read</button>
</div>

<div>
  Device Information Service
  <button id="bt_devid">Device ID</button>
  <button id="bt_fwver">FW Version</button>
</div>

<div>
  mruby Service
  <button id="bt_ledon">LED ON</button>
  <button id="bt_ledoff">LED OFF</button>
</div>

<div>
  Write Test
  <input type="text" id="InpProximity" size="32">
  <button id="bt_wrtpro">Write Proximity UUID</button>
</div>

<div>
  Binary Transfer Test
  <input type="file" id="selmrb">
  <pre id="bin"></pre>
</div>

<div>
  Scan sample
  <div>
    Peripheral name:
    <input type="text" id="target_name">
    <button id="wbt_scanname" onclick="ble.scanByName(document.getElementById('target_name').value);">scanByName() test</button>
  </div>
  <div>
    Peripheral name prefix:
    <input type="text" id="target_name_prefix">
    <button id="wbt_scanpre" onclick="ble.scanByNamePrefix(document.getElementById('target_name_prefix').value);">scanByNamePrefix() test</button>
  </div>
  <div>
    Pripheral service UUID:
    <input type="text" id="target_uuid">
    <button id="wbt_scanuuid" onclick="ble.scanByUUID(document.getElementById('target_uuid').value);">scanByUUID() test</button>
  </div>
</div>

<script>
// //Global
// var ble = new BlueJelly();
// var cnt = 0;

//onLoad
window.onload = function() {
  // // Beacon Service: 24620100-1f7e-4adb-936a-ba3687e99b18
  // // 0201: Proximity UUID
  // ble.setUUID("Proximity",  "24620100-1f7e-4adb-936a-ba3687e99b18", "24620101-1f7e-4adb-936a-ba3687e99b18");
  // // 0202: Major
  // ble.setUUID("Major",      "24620100-1f7e-4adb-936a-ba3687e99b18", "24620102-1f7e-4adb-936a-ba3687e99b18");
  // // 0203: Minor
  // ble.setUUID("Minor",      "24620100-1f7e-4adb-936a-ba3687e99b18", "24620103-1f7e-4adb-936a-ba3687e99b18");
  // // 0204: Tx Power
  // ble.setUUID("TXPower",    "24620100-1f7e-4adb-936a-ba3687e99b18", "24620104-1f7e-4adb-936a-ba3687e99b18");
  // // 0205: Adv. interval
  // ble.setUUID("AdvIntr",    "24620100-1f7e-4adb-936a-ba3687e99b18", "24620105-1f7e-4adb-936a-ba3687e99b18");
  // // 0206: Measure Power
  // ble.setUUID("MesPower",   "24620100-1f7e-4adb-936a-ba3687e99b18", "24620106-1f7e-4adb-936a-ba3687e99b18");
  // // 0207: Regisger
  // ble.setUUID("Register",   "24620100-1f7e-4adb-936a-ba3687e99b18", "24620107-1f7e-4adb-936a-ba3687e99b18");


  // // Data Service: 24620200-1f7e-4adb-936a-ba3687e99b18
  // // Data Write
  // ble.setUUID("DataWrite",  "24620200-1f7e-4adb-936a-ba3687e99b18", "24620201-1f7e-4adb-936a-ba3687e99b18");
  // // Data Notify
  // ble.setUUID("DataNotify", "24620200-1f7e-4adb-936a-ba3687e99b18", "24620202-1f7e-4adb-936a-ba3687e99b18");

  // // Device Information Service: 24620300-1f7e-4adb-936a-ba3687e99b18
  // // Device ID
  // ble.setUUID("DeviceID",   "24620300-1f7e-4adb-936a-ba3687e99b18", "24620301-1f7e-4adb-936a-ba3687e99b18");
  // // Firmware Version
  // ble.setUUID("FWVer",      "24620300-1f7e-4adb-936a-ba3687e99b18", "24620302-1f7e-4adb-936a-ba3687e99b18");

  // // mruby Service
  // // WRITE_APP
  // ble.setUUID("WriteApp",   "24625200-1f7e-4adb-936a-ba3687e99b18", "24625204-1f7e-4adb-936a-ba3687e99b18");
  setup_bluetooth(ble);

  document.getElementById("fl_appbin").addEventListener("change", function(evt) {
    const input = evt.target;
    if (input.files.length == 0) {
      alert("No file selected.");
      return;
    }
    load_appbin(input.files[0]);
  })
}

// ClickEvents
// iBeacon Service
document.getElementById("bt_proximity").addEventListener("click", function(){ble.read("Proximity");});
document.getElementById("bt_major").addEventListener("click", function(){ble.read("Major");});
document.getElementById("bt_minor").addEventListener("click", function(){ble.read("Minor");});
document.getElementById("bt_txpwr").addEventListener("click", function(){ble.read("TXPower");});
document.getElementById("bt_advint").addEventListener("click", function(){ble.read("AdvIntr");});
document.getElementById("bt_mespwr").addEventListener("click", function(){ble.read("MesPower");});
document.getElementById("bt_regi").addEventListener("click", function(){
  dt = [0x01];
  ble.write("Register", dt);
  ble.reset();
  alert("Parameter updated.");
});

document.getElementById("bt_wrtpro").addEventListener("click", function(){
  uuid = document.getElementById("InpProximity").value;
  id = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
  for (var i=0; i<uuid.length/2; i++) {
    id[i] = parseInt(uuid.substr(i*2, 2), 16);
  }
  // alert(id);
  ble.write("Proximity", id);
});

// Data Service
document.getElementById("button1").addEventListener("click", function(){
  ble.read("DataNotify");
  ble.startNotify("DataNotify");
});
document.getElementById("button2").addEventListener("click", function(){ble.stopNotify("DataNotify");});

// Device Information Service
document.getElementById("bt_devid").addEventListener("click", function(){ble.read("DeviceID");});
document.getElementById("bt_fwver").addEventListener("click", function(){ble.read("FWVer");});

// mruby Service
document.getElementById("bt_ledoff").addEventListener("click", function(){
  wrtseq = -1;
  cmd = [0x00];
  ble.write("WriteApp", cmd);
});
document.getElementById("bt_ledon").addEventListener("click", function(){
  wrtseq = -1;
  cmd = [0x01];
  ble.write("WriteApp", cmd);
});

// mrb file transfer
// var wrtseq = -1;
// var mrbreader = null;
// var mrbbuf = [0x06, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
// const mrb_chunk_start = 3;
// const mrb_chunk_size = 16;
// var mrbbin = null;

// // transfer mrb chunk
// function trans_mrb(seq) {
//   if (seq >= mrbbin.byteLength / mrb_chunk_size) {
//     alert("Transfer completed.");
//     wrtseq = -1;
//     let buf = [0x07, 0x70, 0x61, 0x73, 0x73, 0x00];
//     ble.write("WriteApp", buf);
//     return;
//   }

//   mrbbuf[1] = Math.floor(seq / 256);
//   mrbbuf[2] = seq % 256;

//   for (var i=0; i<mrb_chunk_size; i++) {
//     mrbbuf[mrb_chunk_start + i] = mrbbin[seq * mrb_chunk_size + i];
//   }
//   ble.write("WriteApp", mrbbuf);
//   document.getElementById("bin").innerHTML = seq + ": " + mrbbuf;
// }

// load mrb
document.getElementById("selmrb").addEventListener("change", function(evt) {
  const input = evt.target;
  if (input.files.length == 0) {
    alert("No file selected.");
    return;
  }
  // const file = input.files[0];
  // // alert(file.name);
  // mrbreader = new FileReader();
  // mrbreader.onload = function() {
  //   // initialize sequence number
  //   wrtseq = 0;
  //   mrbbin = new Uint8Array(mrbreader.result);

  //   // trans_mrb(wrtseq);
  //   trans_mrb(ble, wrtseq);
  // };
  // mrbreader.readAsArrayBuffer(file);
  start_trans_mrb(ble, input.files[0]);
});

// // onWrite
// ble.onWrite = function(uuid) {
//   // console.log("onWrite: " + uuid);
//   if (uuid == "WriteApp" && wrtseq >= 0) {
//     wrtseq++;
//     // trans_mrb(wrtseq);
//     trans_mrb(ble, wrtseq);
//   }
// }

// // onRead
// ble.onRead = function(data, uuid) {
//   var val = uuid + ": ";
//   for (var i=0; i<data.byteLength; i++) {
//     value = data.getUint8(i);
//     val += value;
//     val += ','
//   }
//   document.getElementById("text1").innerHTML = val;
// }

// // onScan
// ble.onScan = function(deviceName) {
//   document.getElementById('devname').innerHTML = deviceName;
// }

// ble.onConnectGATT = function(uuid) {console.log("onConnectGAT: " + uuid);}  // onConnectGATT
// ble.onStartNotify = function(uuid) {console.log("onStartNotify: " + uuid);} // onStartNotify
// ble.onStopNotify = function(uuid) {console.log("onStopNotify: " + uuid);}   // onStopNotify
// ble.onDisconnect = function() {console.log("onDisconnect");}                // onDisconnect
// ble.onClear = function() {console.log("onClear");}                          // onClear
// ble.onError = function(error) {console.log("onError: " + error);}           // onError
</script>

</body>
</html>
